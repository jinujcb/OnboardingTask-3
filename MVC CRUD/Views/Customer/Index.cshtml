

@{
    ViewBag.Title = "Index";
}


<body>
    <br />
    <h2>Customer Details</h2>
    <br />
    
    <a href="#" class="btn btn-primary" data-bind="click: create" margin-left=12px>Add New Customer</a>
    <br />
    <br />
    <table id="CustomerTable" class="table table-striped table-bordered" style="width:25%;margin-left:12px">

        <thead>
            <tr>
                <th>Name</th>
                <th>Address</th>
                <th>Action(Edit)</th>
                <th>Action(Delete)</th>
            </tr>
        </thead>

        <tbody id="SetCustomerList" data-bind="foreach: customers">

            <tr>

                <td class="Name" id="cname" data-bind="text: Name"></td>
                <td class="Address" id="caddress" data-bind="text: Address"></td>
                <td>
                    <a class="btn btn-warning btn-sm " data-bind="click: edit , attr: {'id' : ID} " style="color:white; margin-left:10px"><i class="fa fa-pencil "></i> Edit</a>
                </td>
                <td>
                    <a class="btn btn-danger btn-sm " data-bind="click: del , attr: {'id' : ID} " style="color:white; margin-left:10px"><i class="fa fa-pencil "></i> Delete</a>

                </td>
            </tr>

        </tbody>

    </table>



    <div id="Modal" class=" modal fade Modal">
        <div class="modal-dialog">
            <div class="modal-content">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h3 class="modal-title" id="m_Title" style="margin-right:20px"></h3>
                    @Html.ActionLink("x", "Index", "Customer", new { @class = "close" })
                </div>

                <div class="modal-body">
                    @Html.Label("Name")
                    <br />
                    <input type="text" name="Name" id="Name" data-bind="textInput: Name, valueUpdate: 'afterkeydown'" />
                    <br />
                    <br />
                    @Html.Label("Address")
                    <br />
                    <input type="text" name="Address" id="Address" data-bind="textInput: Address, valueUpdate: 'afterkeydown'" />
                    <br />
                </div>
                <div class="modal-footer">
                    <input type="submit" value="Save" class="btn btn-primary" id="btnSubmit" />
                    @Html.ActionLink("Close", "Index", "Customer", new { @class = "btn btn-danger" })

                </div>
            </div>
        </div>
    </div>


</body>
@section scripts{
    <script src="~/Scripts/knockout-3.4.2.js"></script>
    <script src="~/Scripts/knockout.validation.js"></script>
 
    <script>
      
   
        $(document).ready(function () {

       /*     ko.extenders.required = function (target, overrideMessage) {
                target.hasError = ko.observable();
                target.validationMessage = ko.observable();

                function validate(newvalue) {
                    target.hasError(newvalue ? false : true);
                    target.validationMessage(newvalue ? "" : overrideMessage || "This field is required");
                }

                validate(target());

                target.subscribe(validate);
                return target;
            }*/
            ko.validation.init({
                registerExtenders: true,
                messagesOnModified: true,
                insertMessages: true,
                parseInputAttributes: true,
                messageTemplate: null,
                errorClass: 'text-danger'
            }, true); 
          

            var viewModelvalidate = ko.validatedObservable({
                ID: ko.observable(),
                Name: ko.observable().extend({ required: { message: 'Please supply your name' } }),
                Address: ko.observable().extend({ required: true }),
            });

            var masterViewModel = {
                v1: new viewModel(),
                v2: new viewModelvalidate()
            }
             //  viewModel.errors = ko.validation.group(viewModel); 
            var viewModel =  {
             
                ID : ko.observable(),
                Name : ko.observable(),
                Address : ko.observable(),
               customers : ko.observableArray([]),//save data function };
            }
        
           
         
            $.ajax({
                type: "GET",
                url: "/Customer/GetAllCustomers",
                success: function (data) {
                    //Put the response in ObservableArray
                    // alert("sucess")
                    viewModel.customers(data);
                    ko.applyBindings(viewModel);
                }
            })

           
            self.create = function () {
                $('#Modal').modal({ show: true });
                $('#m_Title').text("Create Record");
                // alert($('#m_Title').text());
            };

            self.edit = function (data, event) {

                Id = event.target.id;

                $.ajax({
                    url: '/Customer/GetCustomer',
                    method: 'GET',
                    data: { ID: Id },
                    success: function (data) {

                            ID = data.ID,
                            Name = data.Name,
                            Address = data.Address;

                        return true;
                    },

                })

                $('#Modal').modal({ show: true });
                $('#m_Title').text("Edit Record");
                $(".modal-body #Name").val(data.Name);
                $(".modal-body #Address").val(data.Address);

            };
            self.del = function (data, event) {

                Id = event.target.id;

                $.ajax({
                    url: '/Customer/GetCustomer',
                    method: 'GET',
                    data: { ID: Id },
                    success: function (data) {

                        Name = data.Name,
                        Address = data.Address;

                        return true;
                    },

                })
             @*   $('#Modal').modal({ show: true });
                $('#m_Title').text("Delete Record");
                $(".modal-body #Name").val(data.Name);
                $(".modal-body #Address").val(data.Address);*@

                bootbox.confirm("Are you sure you want to delete?", function (result)//jquery library that has inbuit modals, added in layout and bundle only .js file
                {
                    console.log('This was logged in the callback: ' + result);
                    if (result) {
                        var delete_confirm = true;
                        console.log("true");
                        $.ajax({
                            url: '/Customer/Delete',
                            method: 'POST',
                            data: { ID: Id },
                            success: function () {
                                location.reload();
                                return true;
                            },
                            error: function () {

                                location.reload();
                            }

                        })
                    }
                    else {
                        var delete_confirm = false;
                        location.reload();
                    }
                });

            };
         
            $(document).on("click", "#btnSubmit", null, function (ev) {
              
                var current = {
                    Name: $("#Name").val(),
                    Address: $("#Address").val(),
                }
               
           
                
                if (viewModelvalidate.isValid === false) {
                    //    //show all the error messages
                    console.log("false");
                    viewModelvalidate.errors.showAllMessages();
                    //    //stop the screen(next action)
                    return false;
                }
                else {
                    console.log("true");
                   // ko.applyBindings(viewModelvalidate);
                }

                if ($('#m_Title').text() === "Create Record") {

                    $.ajax({
                        url: '/Customer/Index',
                        method: 'POST',
                        data: { Name: current.Name, Address: current.Address },
                        success: function () {

                            location.reload();
                            return true;
                        },
                        error: function () {
                            //  alert("error");
                            location.reload();
                        }
                    })
                }
                else if ($('#m_Title').text() === "Edit Record") {

                    $.ajax({
                        url: '/Customer/Edit',
                        method: 'POST',
                        data: { ID: Id, Name: current.Name, Address: current.Address },
                        success: function () {
                            location.reload();
                            return true;
                        },
                        error: function () {

                            location.reload();
                        }

                    })
                }


            });

            ko.applyBindings(masterViewModel);

         
        });//document




    </script>
}

